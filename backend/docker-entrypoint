#!/bin/bash -e

# If running the web server then migrate existing database
if [ "${*}" == "npm run start:prod" ]; then
  echo "=========================================="
  echo "Prisma 마이그레이션 실행 중..."
  echo "=========================================="
  
  # 마이그레이션 상태 확인
  echo "마이그레이션 상태 확인 중..."
  npx prisma migrate status || echo "마이그레이션 상태 확인 실패"
  
  # 마이그레이션 실행
  echo "마이그레이션 배포 시도 중..."
  npx prisma migrate deploy || {
    echo "❌ 마이그레이션 배포 실패, 스키마에서 직접 생성 시도..."
    
    # 마이그레이션이 없으면 스키마에서 직접 생성
    echo "Prisma 스키마에서 데이터베이스 생성 시도..."
    npx prisma db push --accept-data-loss || {
      echo "❌ db push도 실패했습니다. 수동 마이그레이션이 필요할 수 있습니다."
    }
  }
  
  echo "=========================================="
  echo "마이그레이션 완료"
  echo "=========================================="
fi

exec "${@}"
